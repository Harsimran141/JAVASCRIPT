<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div class="w-[550px] h-[450px] bg-gray-200 m-auto mt-4 rounded-md">
        <h1 class="text-center text-2xl text-blue-600 font-bold">User Chat</h1>
        <div class="mt-4">
            <div id="display">
            </div>
            <input id="input" class="ml-4 mt-20 ml-20 w-[400px] h-full rounded-md" type="text">
            <button id="btn" class="bg-blue-500 p-2 rounded-md ml-2 text-white font-medium">Send</button>
        </div>
        <button id ="logout" class="bg-red-800 shadow-md text-center mt-10 ml-[230px] rounded-md text-white w-[60px]">Log Out</button>
    </div>
    <script>
        const logout = document.getElementById("logout");
        const display = document.getElementById("display");
        let ustore = localStorage.getItem("record");
        console.log("141",ustore);
        if(ustore==null){
            window.location = "Ulogin.html"
        }
        let token = JSON.parse(ustore);
        const input = document.getElementById("input");
        const send = document.getElementById("btn");
        logout.addEventListener("click",()=>{
            // let revoveuser = localStorage.getItem("record");
            // let clearspace = JSON.parse(revoveuser)
            console.log("click");
            
            if(token){
                localStorage.removeItem("record")
               window.location= "Uregistration.html"
            }
            
        })
        send.addEventListener('click', () => {
            let messent = input.value;
            sendMessage(messent)
            input.value = "";
        })
        async function createchat() {
            let option = {
                method: "POST",
                headers: {
                    accept: 'application/json',
                    'content-type': 'application/json',
                    Authorization: `Bearer ${token.data.accessToken}`,
                }
            }
            let storeid = localStorage.getItem("reciverid");
            try {
                let response = await fetch(`https://api.freeapi.app/api/v1/chat-app/chats/c/${storeid}`, option);
                let chat = await response.json()
                console.log("os", chat);
                let chatid = chat.data._id
                console.log("idd", chatid);
                localStorage.setItem("chatid", chatid)
            } catch (error) {
                console.log(error);
            }
        }
        createchat()
        async function sendMessage(message) {
            // console.log("mess", message);
            let chatid = localStorage.getItem("chatid");
            // console.log("newid", chatid);
            try {
                let option = {
                    method: "POST",
                    headers: {
                        accept: 'application/json',
                        'content-type': 'application/json',
                        Authorization: `Bearer ${token.data.accessToken}`,
                    },
                    body: JSON.stringify({
                        "content": message
                    })
                }
                let response = await fetch(`https://api.freeapi.app/api/v1/chat-app/messages/${chatid}`, option)
                let uresponse = await response.json()
                getmessages()
                // console.log("res", uresponse);
            } catch (err) {
                console.log(err);
            }
        }
        sendMessage()
        async function deletemessage(messageId) {
            let ChatId = localStorage.getItem("chatid");
           
            console.log("11", ChatId);
            console.log("12", messageId);


            try {
                let option = {
                    method: "DELETE",
                    headers: {
                        accept: 'application/json',
                        'content-type': 'application/json',
                        Authorization: `Bearer ${token.data.accessToken}`,
                    }


                }
                let response = await fetch(
                `https://api.freeapi.app/api/v1/chat-app/messages/${ChatId}/${messageId}`,option)
                let delmessage = await response.json();
                getmessages()
                console.log("DEL",delmessage);
            } catch (delerror) {
                console.log(delerror);
            }
        }
        async function getmessages() {
            let getchatid = localStorage.getItem("chatid");
            // console.log("getid", getchatid);
            try {
                let option = {
                    method: "GET",
                    headers: {
                        accept: 'application/json',
                        'content-type': 'application/json',
                        Authorization: `Bearer ${token.data.accessToken}`,
                    },
                }
                let response = await fetch(`https://api.freeapi.app/api/v1/chat-app/messages/${getchatid}`, option)
                let getmessages = await response.json()
                // console.log("ALLMESSAGES", getmessages);
                let show = ""
                getmessages.data.forEach(element => {
                    //  console.log("1",element.sender._id);
                    let senderid = element.sender._id;
                    let record = localStorage.getItem("record")
                    record = JSON.parse(record)
                    //   console.log("a",record.data.user._id);
                    let currentuserid = record.data.user._id;
                    if (currentuserid == senderid) {
                        show += `
                       <div class="w-full h-10 bg-green-300 flex justify-end">
                           <h1 class="w-[20%] h-10 text-white bg-red-800 message"id="${element._id}">${element.content}</h1>
                           <button class="bg-blue-800" onclick="deletemessage('${element._id}')">DEL</button>
                       </div>`
                    } else {
                        show += `
                     <div class="w-full h-10 bg-green-300 flex justify-start">
                         <h1 class="w-[20%] h-10 bg-blue-400 message" id="${element._id}">${element.content}</h1>
                         </div>`
                    }

                });

                display.innerHTML = show
                let mess = document.querySelectorAll(".message");
                mess.forEach(listmessage => {
                    listmessage.addEventListener("click", () => {
                        let nmess = listmessage.getAttribute("id")


                        //localStorage.setItem("reciverid", nmess)
                    })

                });
            } catch (errs) {
                console.log(errs);
            }

        }

        // setInterval(()=>{

        // },2000)
    </script>
</body>

</html>