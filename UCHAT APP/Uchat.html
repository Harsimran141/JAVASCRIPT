<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div class="w-[550px] h-[450px] bg-gray-200 m-auto mt-4 rounded-md">
        <h1 class="text-center text-2xl text-blue-600 font-bold">User Chat</h1>
        <div class="mt-4">
            <div id="display">
            </div>
            <input id="input" class="ml-4 mt-20 ml-20 w-[400px] h-full rounded-md" type="text">
            <button id="btn" class="bg-blue-500 p-2 rounded-md ml-2 text-white font-medium">Send</button>
        </div>
    </div>
    <script>
        const display = document.getElementById("display");
        let ustore = localStorage.getItem("record");
        let token = JSON.parse(ustore);
        const input = document.getElementById("input");
        const send = document.getElementById("btn");
        send.addEventListener('click', () => {
            let messent = input.value;
            sendMessage(messent)
        })
        async function createchat() {
            let option = {
                method: "POST",
                headers: {
                    accept: 'application/json',
                    'content-type': 'application/json',
                    Authorization: `Bearer ${token.data.accessToken}`,
                }
            }
            let storeid = localStorage.getItem("reciverid");
            try {
                let response = await fetch(`https://api.freeapi.app/api/v1/chat-app/chats/c/${storeid}`, option);
                let chat = await response.json()
                console.log("os", chat);
                let chatid = chat.data._id
                console.log("idd", chatid);
                localStorage.setItem("chatid", chatid)
            } catch (error) {
                console.log(error);
            }
        }
        createchat()
        async function sendMessage(message) {
            // console.log("mess", message);
            let chatid = localStorage.getItem("chatid");
            // console.log("newid", chatid);
            try {
                let option = {
                    method: "POST",
                    headers: {
                        accept: 'application/json',
                        'content-type': 'application/json',
                        Authorization: `Bearer ${token.data.accessToken}`,
                    },
                    body: JSON.stringify({
                        "content": message
                    })
                }
                let response = await fetch(`https://api.freeapi.app/api/v1/chat-app/messages/${chatid}`, option)
                let uresponse = await response.json()
                getmessages()
                // console.log("res", uresponse);
            } catch (err) {
                console.log(err);
            }
        }
        sendMessage()
        async function getmessages() {
            let getchatid = localStorage.getItem("chatid");
            // console.log("getid", getchatid);
            try {
                let option = {
                    method: "GET",
                    headers: {
                        accept: 'application/json',
                        'content-type': 'application/json',
                        Authorization: `Bearer ${token.data.accessToken}`,
                    },
                }
                let response = await fetch(`https://api.freeapi.app/api/v1/chat-app/messages/${getchatid}`, option)
                let getmessages = await response.json()
                console.log("ALLMESSAGES", getmessages);
                // let nmess = getmessages.data.sender._id;
                let show = ""
                getmessages.data.forEach(element => {
                    // console.log("umess", element);
                    show += `
               <div class="text-center">
               <h1 class="text-green-800">${element.content}</h1>
               <p class="text-red-900">${element.sender.username}</p>
            
               </div`
               });
                // console.log("iii", show);
                display.innerHTML = show
                } catch (errs) {
                console.log(errs);
            }
            }
        // setInterval(()=>{
        //    getmessages() 
        // },2000)
    </script>
</body>

</html>